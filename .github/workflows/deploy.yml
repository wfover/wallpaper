name: Deploy to GitHub Pages

on:
  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [main]

  # å®šæ—¶è§¦å‘ï¼šæ¯å¤© UTC 18:00ï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥ 02:00ï¼‰- ä½å³°æœŸ,å›¾åºŠåŒæ­¥å 2 å°æ—¶éƒ¨ç½²
  schedule:
    - cron: '0 18 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½® GITHUB_TOKEN æƒé™
# è®¾ç½® GITHUB_TOKEN æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest CDN version from nuanXinProPic
        id: cdn_version
        run: |
          # ä½¿ç”¨ GitHub API è·å–å›¾åºŠä»“åº“çš„æœ€æ–° tag
          LATEST_TAG=$(curl -s "https://api.github.com/repos/IT-NuanxinPro/nuanXinProPic/tags" | jq -r '.[0].name // "v1.0.4"')

          # å¦‚æœ API è¿”å›ç©ºæˆ–é”™è¯¯ï¼Œä½¿ç”¨å¤‡ç”¨é»˜è®¤å€¼
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" == "null" ]; then
            LATEST_TAG="v1.0.4"
            echo "âš ï¸ Failed to get tag from API, using fallback: $LATEST_TAG"
          else
            echo "âœ… Got latest CDN version: $LATEST_TAG"
          fi

          echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Update CDN version in constants.js
        run: |
          CDN_VERSION="${{ steps.cdn_version.outputs.version }}"
          echo "ğŸ“¦ Updating CDN_VERSION to: $CDN_VERSION"

          # ä½¿ç”¨ sed æ›¿æ¢ç‰ˆæœ¬å·
          sed -i "s/export const CDN_VERSION = '[^']*'/export const CDN_VERSION = '$CDN_VERSION'/" src/utils/constants.js

          # éªŒè¯æ›¿æ¢ç»“æœ
          echo "âœ… Updated constants.js:"
          grep "CDN_VERSION" src/utils/constants.js

      - name: Checkout nuanXinProPic (wallpaper source)
        uses: actions/checkout@v4
        with:
          repository: IT-NuanxinPro/nuanXinProPic
          path: nuanXinProPic
          fetch-depth: 1  # åªéœ€æœ€æ–°ç‰ˆæœ¬ï¼Œæ—¶é—´æˆ³ä»å¤‡ä»½æ–‡ä»¶æ¢å¤

      # æ€§èƒ½ä¼˜åŒ–: ä¸å†æ¢å¤æ–‡ä»¶æ—¶é—´æˆ³
      # generate-data.js ç›´æ¥ä» timestamps-backup-all.txt è¯»å–æ—¶é—´æˆ³,æ— éœ€æ¢å¤æ–‡ä»¶ mtime
      # è¿™é¿å…äº† touch æ•°ç™¾/æ•°åƒä¸ªæ–‡ä»¶,æ˜¾è‘—æå‡æ„å»ºé€Ÿåº¦
      - name: Verify timestamp backup file
        run: |
          cd nuanXinProPic

          if [ -f "timestamps-backup-all.txt" ]; then
            TOTAL=$(wc -l < timestamps-backup-all.txt | tr -d ' ')
            echo "âœ… Found timestamps-backup-all.txt"
            echo "ğŸ“Š Total images with timestamp records: $TOTAL"
            echo "â„¹ï¸  generate-data.js will read timestamps from this file directly"
          else
            echo "âš ï¸ Warning: timestamps-backup-all.txt not found"
            echo "â„¹ï¸  generate-data.js will use file system mtime (not recommended)"
          fi

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install ImageMagick (for image dimensions)
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      # generate-data.js å·²åŒ…å«åœ¨ pnpm build ä¸­ï¼Œæ— éœ€å•ç‹¬æ‰§è¡Œ

      - name: Build
        run: pnpm build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Purge Cloudflare cache
        if: success()
        run: |
          echo "ğŸ§¹ Purging Cloudflare cache..."

          # æ¸…é™¤å…³é”®æ–‡ä»¶ç¼“å­˜ï¼ˆindex.html å’Œ version.jsonï¼‰
          RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"files":["https://wallpaper.061129.xyz/","https://wallpaper.061129.xyz/index.html","https://wallpaper.061129.xyz/version.json"]}')

          # æ£€æŸ¥å“åº”
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… Successfully purged version.json cache"
          else
            echo "âš ï¸ Cache purge response: $RESPONSE"
          fi
