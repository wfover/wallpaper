name: Deploy to GitHub Pages

on:
  # æŽ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [main]

  # å®šæ—¶è§¦å‘ï¼šæ¯å¤© UTC 0:00ï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰è‡ªåŠ¨åŒæ­¥å£çº¸æ•°æ®
  schedule:
    - cron: '0 0 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½® GITHUB_TOKEN æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest CDN version from nuanXinProPic
        id: cdn_version
        run: |
          # ä½¿ç”¨ GitHub API èŽ·å–å›¾åºŠä»“åº“çš„æœ€æ–° tag
          LATEST_TAG=$(curl -s "https://api.github.com/repos/IT-NuanxinPro/nuanXinProPic/tags" | jq -r '.[0].name // "v1.0.4"')

          # å¦‚æžœ API è¿”å›žç©ºæˆ–é”™è¯¯ï¼Œä½¿ç”¨å¤‡ç”¨é»˜è®¤å€¼
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" == "null" ]; then
            LATEST_TAG="v1.0.4"
            echo "âš ï¸ Failed to get tag from API, using fallback: $LATEST_TAG"
          else
            echo "âœ… Got latest CDN version: $LATEST_TAG"
          fi

          echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Update CDN version in constants.js
        run: |
          CDN_VERSION="${{ steps.cdn_version.outputs.version }}"
          echo "ðŸ“¦ Updating CDN_VERSION to: $CDN_VERSION"

          # ä½¿ç”¨ sed æ›¿æ¢ç‰ˆæœ¬å·
          sed -i "s/export const CDN_VERSION = '[^']*'/export const CDN_VERSION = '$CDN_VERSION'/" src/utils/constants.js

          # éªŒè¯æ›¿æ¢ç»“æžœ
          echo "âœ… Updated constants.js:"
          grep "CDN_VERSION" src/utils/constants.js

      - name: Checkout nuanXinProPic (wallpaper source)
        uses: actions/checkout@v4
        with:
          repository: IT-NuanxinPro/nuanXinProPic
          path: nuanXinProPic
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œç”¨äºŽæ¢å¤æ—¶é—´æˆ³

      - name: Restore file timestamps from backup
        run: |
          cd nuanXinProPic

          # ä¼˜å…ˆä½¿ç”¨å®Œæ•´å¤‡ä»½æ–‡ä»¶ï¼ˆåŒ…å«æ‰€æœ‰ä¸‰ä¸ªç³»åˆ—ï¼‰
          if [ -f "timestamps-backup-all.txt" ]; then
            echo "âœ… Found timestamps-backup-all.txt, restoring all file timestamps..."

            # ä½¿ç”¨å®Œæ•´å¤‡ä»½æ–‡ä»¶æ¢å¤æ—¶é—´æˆ³
            chmod +x scripts/restore-timestamps.sh
            BACKUP_FILE=timestamps-backup-all.txt ./scripts/restore-timestamps.sh

            echo "âœ… All file timestamps restored from backup"
          elif [ -f "timestamps-backup.txt" ]; then
            echo "âœ… Found timestamps-backup.txt, restoring desktop file timestamps..."

            # ä½¿ç”¨æ—§çš„å¤‡ä»½æ–‡ä»¶ï¼ˆä»… desktopï¼‰
            chmod +x scripts/restore-timestamps.sh
            ./scripts/restore-timestamps.sh

            echo "âœ… Desktop file timestamps restored from backup"
          else
            echo "âš ï¸ No timestamps backup file found, skipping timestamp restoration"
          fi

          # éªŒè¯ï¼šæ˜¾ç¤ºå‡ ä¸ªæ–‡ä»¶çš„æ—¶é—´
          echo "ðŸ“… Sample file timestamps:"
          echo "Desktop:"
          ls -lh wallpaper/desktop/åŠ¨æ¼«/äºŒæ¬¡å…ƒ/ 2>/dev/null | head -3 || echo "Desktop directory not found"
          echo "Mobile:"
          ls -lh wallpaper/mobile/åŠ¨æ¼«/ 2>/dev/null | head -3 || echo "Mobile directory not found"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install ImageMagick (for image dimensions)
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Generate wallpaper data
        run: node scripts/generate-data.js

      - name: Build
        run: pnpm build

      - name: Prerender pages for SEO
        run: node scripts/prerender.js

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
